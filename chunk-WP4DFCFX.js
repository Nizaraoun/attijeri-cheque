import{b as d,c as h,d as E,e as m,h as p,i as b,j as y,k as C,r as c}from"./chunk-YFRBFD7N.js";import{A as g,P as R,Pb as B,U as v,a as f,b as k,n as l,o as r,pa as D,s as u}from"./chunk-TPGXXVT3.js";var O=class q{constructor(i){this.platformId=i;this.isBrowser=B(this.platformId),this.isBrowser&&(this.db=E(),this.loadSettings())}db;isBrowser;eligibilitySettings=null;chequeBookSettings=null;loadSettings(){this.getEligibilitySettings().subscribe(),this.getChequeBookSettings().subscribe()}getCheckRequests(){if(!this.isBrowser)return r([]);let i=d(c,"checkRequests"),t=m(i);return l(b(t)).pipe(u(e=>{let s=[];return e.forEach(a=>{let n=a.data();s.push(f({id:a.id},n))}),s}),g(e=>(console.error("Error fetching check requests:",e),r([]))))}updateCheckRequestStatus(i,t,e){return this.isBrowser?r(!0):r(!1)}createCheckRequest(i){let t=k(f({},i),{id:`CHK-${Math.floor(Math.random()*1e3)}`,requestDate:new Date,status:"pending"});return r(t)}getEligibilitySettings(){if(!this.isBrowser)return r(this.getDefaultEligibilitySettings());if(this.eligibilitySettings)return r(this.eligibilitySettings);let i=h(c,"settings","eligibilityCriteria");return l(p(i)).pipe(u(t=>{if(t.exists())return this.eligibilitySettings=t.data(),this.eligibilitySettings;{let e=this.getDefaultEligibilitySettings();return this.saveEligibilitySettings(e).subscribe(),e}}),g(t=>{console.error("Error fetching eligibility settings:",t);let e=this.getDefaultEligibilitySettings();return r(e)}))}getChequeBookSettings(){if(!this.isBrowser)return r(this.getDefaultChequeBookSettings());if(this.chequeBookSettings)return r(this.chequeBookSettings);let i=h(c,"settings","chequeBookSettings");return l(p(i)).pipe(u(t=>{if(t.exists())return this.chequeBookSettings=t.data(),this.chequeBookSettings;{let e=this.getDefaultChequeBookSettings();return this.saveChequeBookSettings(e).subscribe(),e}}),g(t=>{console.error("Error fetching checkbook settings:",t);let e=this.getDefaultChequeBookSettings();return r(e)}))}saveEligibilitySettings(i){if(!this.isBrowser)return r(!1);let t=h(c,"settings","eligibilityCriteria");return i.lastUpdated=new Date,l(y(t,i)).pipe(u(()=>(this.eligibilitySettings=i,!0)),g(e=>(console.error("Error saving eligibility settings:",e),r(!1))))}saveChequeBookSettings(i){if(!this.isBrowser)return r(!1);let t=h(c,"settings","chequeBookSettings");return i.lastUpdated=new Date,l(y(t,i)).pipe(u(()=>(this.chequeBookSettings=i,!0)),g(e=>(console.error("Error saving checkbook settings:",e),r(!1))))}getDefaultEligibilitySettings(){return{maxCnpValue:"0",maxClassificationValue:"0",maxRegularizedWarnings:8,maxChecksInCirculation:15,lastUpdated:new Date}}getDefaultChequeBookSettings(){return{cmcNetRanges:[{minValue:1e3,maxValue:2e3,sheetsCount:15,limitPerSheet:700,totalLimit:10500,validityPeriod:12},{minValue:2001,maxValue:3e3,sheetsCount:25,limitPerSheet:1e3,totalLimit:25e3,validityPeriod:12},{minValue:3001,maxValue:Number.MAX_SAFE_INTEGER,sheetsCount:25,limitPerSheet:1200,totalLimit:3e4,validityPeriod:12}],lastUpdated:new Date}}checkEligibility(i){return this.getEligibilityCriteria(i).pipe(u(t=>{if(this.eligibilitySettings||(this.eligibilitySettings=this.getDefaultEligibilitySettings()),t.cnp===this.eligibilitySettings.maxCnpValue&&t.classification===this.eligibilitySettings.maxClassificationValue&&t.regularizedWarnings<this.eligibilitySettings.maxRegularizedWarnings&&t.checksInCirculation<this.eligibilitySettings.maxChecksInCirculation&&!t.hasClientOpposition&&!t.hasJudicialFreeze)return{eligible:!0};{let s=[];return t.cnp!==this.eligibilitySettings.maxCnpValue&&s.push("CNP classification not eligible"),t.classification!==this.eligibilitySettings.maxClassificationValue&&s.push("Customer classification not eligible"),t.regularizedWarnings>=this.eligibilitySettings.maxRegularizedWarnings&&s.push("Too many regularized warnings"),t.checksInCirculation>=this.eligibilitySettings.maxChecksInCirculation&&s.push("Too many checks in circulation"),t.hasClientOpposition&&s.push("Client opposition found"),t.hasJudicialFreeze&&s.push("Judicial freeze detected"),{eligible:!1,reason:s.join(", ")}}}))}getEligibilityCriteria(i){return r({cnp:"0",classification:"0",regularizedWarnings:Math.floor(Math.random()*10),checksInCirculation:Math.floor(Math.random()*20),hasClientOpposition:Math.random()>.8,hasJudicialFreeze:Math.random()>.9})}getCustomerCMCNet(i){let t=Math.floor(Math.random()*5e3);return r(t)}getChequeBookOffer(i){return this.getChequeBookSettings().pipe(u(t=>{let e=t.cmcNetRanges.find(s=>i>=s.minValue&&i<=s.maxValue);return e?{cmcNet:i,sheetsCount:e.sheetsCount,limitPerSheet:e.limitPerSheet,totalLimit:e.totalLimit,validityPeriod:e.validityPeriod}:null}))}getDerogationRequests(){if(!this.isBrowser)return r([]);let i=d(c,"derogations"),t=m(i);return l(b(t)).pipe(u(e=>{let s=[];return e.forEach(a=>{let n=a.data();s.push(f({requestId:a.id},n))}),s}),g(e=>(console.error("Error fetching derogation requests:",e),r([]))))}updateDerogationStatus(i,t,e){if(!this.isBrowser)return r(!1);let s=h(c,"derogationRequests",i),a={status:t,dateProcessed:new Date};return e&&(a.adminComment=e),l(C(s,a)).pipe(u(()=>!0),g(n=>(console.error("Error updating derogation status:",n),r(!1))))}confirmChequeBookRequest(i,t,e){return this.createCheckRequest({accountNumber:i,customerName:t,checkCount:e.sheetsCount})}getPendingCheques(){if(!this.isBrowser)return r([]);let i=d(c,"my_cheque"),t=m(i);return l(b(t)).pipe(u(e=>{let s=[];return e.forEach(a=>{let n=a.data();n&&n.issuedCheques&&Array.isArray(n.issuedCheques)&&n.issuedCheques.filter(o=>o.status==="pending").forEach(o=>{s.push({id:o.id||o.checkNumber,amount:o.amount,bank:o.bank,beneficier:o.beneficier,checkNumber:o.checkNumber,confirmed:o.confirmed,date:o.date,date_of_scan:o.date_of_scan,id_donateur:o.id_donateur,is_reserved:o.is_reserved||!1,issuerBank:o.issuerBank,montant:o.montant,nom:o.nom,recipient:o.recipient,recipient_id:o.recipient_id,reservation_date:o.reservation_date,status:o.status})})}),s}),g(e=>(console.error("Error fetching pending cheques:",e),r([]))))}deliverChequeToClient(i,t){if(!this.isBrowser)return r(!1);let e=h(c,"my_cheque",i);return l(p(e)).pipe(u(s=>{if(!s.exists())throw new Error("Cheque document not found");let a=s.data(),n=!1;if(a&&a.issuedCheques&&Array.isArray(a.issuedCheques)){let S=a.issuedCheques.map(o=>o.id===t||o.checkNumber===t?(n=!0,k(f({},o),{status:"delivered",deliveryDate:new Date})):o);if(n)return C(e,{issuedCheques:S,updatedAt:new Date}),!0}throw new Error("Cheque not found in the document")}),g(s=>(console.error("Error delivering cheque to client:",s),r(!1))))}getCheckRequestsCount(){if(!this.isBrowser)return r(0);let i=d(c,"cheque"),t=m(i);return l(b(t)).pipe(u(e=>e.size),g(e=>(console.error("Error counting check requests:",e),r(0))))}getDerogationRequestsCount(){if(!this.isBrowser)return r(0);let i=d(c,"derogations"),t=m(i);return l(b(t)).pipe(u(e=>e.size),g(e=>(console.error("Error counting derogation requests:",e),r(0))))}getCheckRequestsFromCheque(){if(!this.isBrowser)return r([]);let i=d(c,"cheque"),t=m(i);return l(b(t)).pipe(u(e=>{let s=[];return e.forEach(a=>{let n=a.data();s.push({id:a.id,accountNumber:n.accountNumber||n.account||"",customerName:n.customerName||n.name||"",checkCount:n.checkCount||n.count||0,requestDate:n.requestDate||n.date||new Date,status:n.status||"pending",reason:n.reason||""})}),s}),g(e=>(console.error("Error fetching cheque collection:",e),r([]))))}getChequeRequestById(i){if(!this.isBrowser)return r(null);let t=h(c,"demande_cheque",i);return l(p(t)).pipe(u(e=>{if(e.exists()){let s=e.data();return f({id:e.id},s)}else return console.error("Cheque request not found:",i),null}),g(e=>(console.error("Error fetching cheque request:",e),r(null))))}getAllChequeRequests(){if(!this.isBrowser)return r([]);let i=d(c,"demande_cheque"),t=m(i);return l(b(t)).pipe(u(e=>{let s=[];return e.forEach(a=>{let n=a.data();s.push(f({id:a.id},n))}),s}),g(e=>(console.error("Error fetching cheque requests:",e),r([]))))}updateChequeRequestStatus(i,t){if(!this.isBrowser)return r(!1);let e=h(c,"demande_cheque",i);return l(C(e,{status:t})).pipe(u(()=>!0),g(s=>(console.error("Error updating cheque request status:",s),r(!1))))}static \u0275fac=function(t){return new(t||q)(v(D))};static \u0275prov=R({token:q,factory:q.\u0275fac,providedIn:"root"})};export{O as a};
